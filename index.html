<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Full Hand Tracking VR</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>
  <video id="input_video" style="display:none;"></video>

  <a-scene environment="preset: contact; cover: false">
    <a-entity camera position="0 1.6 2" look-controls></a-entity>
    
    <a-entity id="hand-container"></a-entity>

    <a-box position="0 1.5 -0.5" scale="0.2 0.2 0.2" color="red"></a-box>
  </a-scene>

  <script>
    const videoElement = document.getElementById('input_video');
    const handContainer = document.getElementById('hand-container');
    const joints = [];

    // 1. 初回に21個の球体（関節）を作成して非表示にしておく
    for (let i = 0; i < 21; i++) {
      const joint = document.createElement('a-sphere');
      joint.setAttribute('radius', '0.02');
      joint.setAttribute('color', '#00ffcc');
      joint.setAttribute('visible', 'false');
      handContainer.appendChild(joint);
      joints.push(joint);
    }

    function onResults(results) {
      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];

        landmarks.forEach((point, index) => {
          // 2. カメラ座標をVR空間の座標にマッピング
          const x = (point.x - 0.5) * -3; // 左右反転と幅調整
          const y = (point.y - 0.5) * -2 + 1.5; // 上下反転と高さ調整
          const z = point.z * 2 - 1; // 奥行き

          joints[index].setAttribute('position', {x: x, y: y, z: z});
          joints[index].setAttribute('visible', 'true');
        });
      } else {
        // 手が見えない時は隠す
        joints.forEach(j => j.setAttribute('visible', 'false'));
      }
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });
    hands.onResults(onResults);

    new Camera(videoElement, {
      onFrame: async () => { await hands.send({image: videoElement}); },
      width: 1280, height: 720
    }).start();
  </script>
</body>
</html>
