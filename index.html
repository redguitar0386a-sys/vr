<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Landscape Fixed Hand VR</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <style>
    #debug-video { position: fixed; top: 10px; right: 10px; width: 120px; border: 2px solid white; z-index: 1000; border-radius: 5px; background: #000; transform: scaleX(-1); }
    #ui { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1001; }
    #start_btn { padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 30px; background: white; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
  </style>
</head>
<body style="margin: 0; background: #000; overflow: hidden;">

  <div id="ui"><button id="start_btn">横画面VRを起動</button></div>
  <video id="debug-video" playsinline></video>

  <a-scene device-orientation-permission-ui="enabled: false">
    <a-entity id="rig">
      <a-entity camera look-controls position="0 1.6 0"></a-entity>
    </a-entity>
    
    <a-box position="0 2.5 0" width="10" height="10" depth="10" material="side: back; shader: flat">
      <a-plane position="0 -4.99 0" rotation="-90 0 0" width="10" height="10" color="#2ecc71"></a-plane>
      <a-plane position="0 4.99 0" rotation="90 0 0" width="10" height="10" color="#3498db"></a-plane>
      <a-plane position="0 0 -4.99" width="10" height="10" color="#f1c40f"></a-plane>
      <a-plane position="0 0 4.99" rotation="0 180 0" width="10" height="10" color="#e74c3c"></a-plane>
      <a-plane position="-4.99 0 0" rotation="0 90 0" width="10" height="10" color="#9b59b6"></a-plane>
      <a-plane position="4.99 0 0" rotation="0 -90 0" width="10" height="10" color="#e67e22"></a-plane>
    </a-box>

    <a-entity id="hand0"></a-entity>
    <a-entity id="hand1"></a-entity>
  </a-scene>

  <script>
    const video = document.getElementById('debug-video');
    const handGroups = [document.getElementById('hand0'), document.getElementById('hand1')];
    const spheres = [[], []];
    const lines = [[], []];
    const FINGER_MAP = [[0,1,2,3,4],[0,5,6,7,8],[0,9,10,11,12],[0,13,14,15,16],[0,17,18,19,20],[5,9,13,17,5]];

    // 手のパーツ作成
    for (let h = 0; h < 2; h++) {
      const color = (h === 0) ? "#00FFFF" : "#FF00FF";
      for (let i = 0; i < 21; i++) {
        let s = document.createElement('a-sphere');
        s.setAttribute('radius', i === 0 ? '0.06' : '0.04');
        s.setAttribute('color', color);
        s.setAttribute('visible', false);
        handGroups[h].appendChild(s);
        spheres[h].push(s);
      }
      FINGER_MAP.forEach(indices => {
        for (let j = 0; j < indices.length - 1; j++) {
          let l = document.createElement('a-entity');
          l.setAttribute('line', {color: color, opacity: 0.8});
          handGroups[h].appendChild(l);
          lines[h].push({ el: l, start: indices[j], end: indices[j+1] });
        }
      });
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6});

    hands.onResults((results) => {
      spheres.forEach(h => h.forEach(s => s.setAttribute('visible', false)));
      lines.forEach(h => h.forEach(l => l.el.setAttribute('visible', false)));

      if (results.multiHandLandmarks) {
        results.multiHandLandmarks.forEach((landmarks, index) => {
          if (index < 2) {
            // 【横画面用の座標軸変換】
            // カメラを横にした時の座標系のズレを補正しています
            const pts = landmarks.map(pt => ({
              x: (pt.x - 0.5) * 5,          // 左右の広がり
              y: (pt.y - 0.5) * -3.5 + 1.6, // 上下の動き
              z: -1.0                      // 奥行きを安定させる
            }));

            pts.forEach((pos, i) => {
              spheres[index][i].setAttribute('position', pos);
              spheres[index][i].setAttribute('visible', true);
            });
            lines[index].forEach(line => {
              const start = pts[line.start], end = pts[line.end];
              line.el.setAttribute('line', `start: ${start.x} ${start.y} ${start.z}; end: ${end.x} ${end.y} ${end.z}`);
              line.el.setAttribute('visible', true);
            });
          }
        });
      }
    });

    async function startApp() {
      if (typeof DeviceOrientationEvent !== 'undefined' && DeviceOrientationEvent.requestPermission) {
        await DeviceOrientationEvent.requestPermission();
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: 1280, height: 720 }
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          const run = async () => {
            if(!video.paused) await hands.send({image: video});
            requestAnimationFrame(run);
          };
          run();
        };
        document.getElementById('ui').style.display = 'none';
      } catch (e) { alert(e); }
    }
    document.getElementById('start_btn').addEventListener('click', startApp);
  </script>
</body>
</html>
